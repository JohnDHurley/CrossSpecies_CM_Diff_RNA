---
title: "RNA_CorrelationHeatMap_Symbol"
output: html_document
date: "2026-01-27"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Setting_Up_Enviroment, results="hide"}

####Library Loading####
library("edgeR")
library("ggplot2")
library("tibble")
library("dplyr")
library("ggrepel")
library("readr")
library("org.Hs.eg.db")
library("AnnotationDbi")
library("pheatmap")
library("Cormotif")
library("tidyverse")
library("workflowr")
library("RUVSeq")
library("SummarizedExperiment")
library("readxl")
library("ggfortify")
library("ComplexHeatmap")

# BiocManager::install("SummarizedExperiment")

ann_colors_No4 <- readRDS("data/QC/ann_colors_no4.RDS")
RNA_fc_df <- readRDS("data/Raw_Data/RNA_fc_df.RDS")
RNA_Metadata <- readRDS("data/Raw_Data/RNA_Metadata.RDS")
Filt_RMGO_RNA_log2cpm_NoD4_unique <- readRDS("data/QC/Symbol/Filt_RMGO_RNA_log2cpm_NoD4_unique.RDS")
RNA_Metadata_No4 <- readRDS("data/QC/RNA_Metatdata_No4.RDS")
```

```{r RNASeq_FeatureCounts_RMG0_No4}
Filt_RMGO_RNA_fc_NoD4 <- readRDS("data/QC/Filt_RMG0_RNA_fc_NoD4.RDS")

####Subset####
Filt_RMGO_RNA_fc_NoD4 <- Filt_RMGO_RNA_fc_NoD4 %>%
  as.data.frame() %>%
  rownames_to_column(var = "ENSEMBL")

gene_symbols <- AnnotationDbi::select(
  org.Hs.eg.db,
  keys = Filt_RMGO_RNA_fc_NoD4$ENSEMBL,
  columns = c("SYMBOL"),
  keytype = "ENSEMBL"
)

# ----------------- Join Back to Main Data -----------------
Filt_RMGO_RNA_fc_NoD4 <- left_join(Filt_RMGO_RNA_fc_NoD4, gene_symbols, by = c("ENSEMBL" = "ENSEMBL"))
Filt_RMGO_RNA_fc_NoD4 <- Filt_RMGO_RNA_fc_NoD4 %>% 
  dplyr::select(-ENSEMBL)

Filt_RMGO_RNA_fc_NoD4_unique <- Filt_RMGO_RNA_fc_NoD4 %>%
  filter(!is.na(SYMBOL)) %>%      # remove NAs
  group_by(SYMBOL) %>%
  slice_max(
    rowSums(abs(pick(where(is.numeric))), na.rm = TRUE),
    n = 1,
    with_ties = FALSE
  ) %>%
  ungroup() %>% 
  column_to_rownames("SYMBOL")

Filt_RMGO_RNA_log2cpm_NoD4_unique <- cpm(Filt_RMGO_RNA_fc_NoD4_unique,log = TRUE) %>% 
  as.data.frame()
# ----------------- Save Annotated Output -----------------
write_csv(Filt_RMGO_RNA_fc_NoD4_unique, "data/QC/Symbol/Filt_RMGO_RNA_fc_NoD4_unique.csv")
write_csv(Filt_RMGO_RNA_log2cpm_NoD4_unique, "data/QC/Symbol/Filt_RMGO_RNA_log2cpm_NoD4_unique.csv")
saveRDS(Filt_RMGO_RNA_fc_NoD4_unique,"data/QC/Symbol/Filt_RMGO_RNA_fc_NoD4_unique.RDS")
saveRDS(Filt_RMGO_RNA_log2cpm_NoD4_unique,"data/QC/Symbol/Filt_RMGO_RNA_log2cpm_NoD4_unique.RDS")

```


```{r rRNASeq_FeatureCounts_Cor_RMG0_No4}

######Cor_HeatMap####

Filt_RMG0_RNA_log2cpm_NoD4 <- Filt_RMGO_RNA_log2cpm_NoD4_unique

Cor_Filt_RMG0_RNA_log2cpm_NoD4 <- cor(Filt_RMG0_RNA_log2cpm_NoD4, method = "spearman")

Cor_metadata_No4 <- RNA_Metadata_No4 %>% 
  dplyr::filter(Timepoint !="Day4")

# saveRDS(Cor_metadata_No4, "data/QC/Symbol/Cor_metadata_No4.RDS")
# saveRDS(Cor_Filt_RMG0_RNA_log2cpm_NoD4, "data/QC/Symbol/Cor_Filt_RMG0_RNA_log2cpm_NoD4.RDS")
```


```{r rRNASeq_FeatureCounts_HeatMap_RMG0_No4,fig.height=10,fig.width=10}
ann_colors_No4$Timepoint <- ann_colors_No4$timepoint_cor
ann_colors_No4$Species <- ann_colors_No4$species_cor
ann_colors_No4$Individual <- ann_colors_No4$individual_cor
print(
  pheatmap(Cor_Filt_RMG0_RNA_log2cpm_NoD4,
         fontsize_row = 5,
         fontsize_col = 5,
         annotation_col = Cor_metadata_No4[, c("Species", "Timepoint","Individual")],
         annotation_colors = ann_colors_No4,
         clustering_distance_rows = "correlation",
         clustering_distance_cols = "correlation",
         main = "Sample-Sample Correlation (Spearman) \n (log2CPM-RowMeans>0-NoDay4)")
)
```

