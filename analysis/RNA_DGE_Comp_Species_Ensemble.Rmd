---
title: "RNA_DGE_Comp_Species_Ensemble"
output: html_document
date: "2026-01-27"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE,
	dev = c("png","pdf")
)
```

```{r Setting the Enviroment}

#Loading Libraries
library(tidyverse)
library(readxl)
library(readr)
library(ggrepel)
library(ggfortify)
library(patchwork)
library(eulerr)
library(org.Hs.eg.db)
library(AnnotationDbi)
library(ggVennDiagram)
library(ggrastr)
library(edgeR)
library(limma)
library("ggsignif")



#Loading R Objects
Filt_RMG0_RNA_fc_NoD4 <- readRDS("data/QC/Filt_RMG0_RNA_fc_NoD4.RDS")

RNA_Metadata <- readRDS("data/Raw_Data/RNA_Metadata.RDS")

RNA_Metadata_NoD4_NoRep <- readRDS("data/DGE/RNA_Metadata_NoD4_NoRep.RDS")

Day0_DEGs_HC <- readRDS("data/DGE/Species/Day0_DEGs_HC.RDS")
Day2_DEGs_HC <- readRDS("data/DGE/Species/Day2_DEGs_HC.RDS")
Day5_DEGs_HC <- readRDS("data/DGE/Species/Day5_DEGs_HC.RDS")
Day15_DEGs_HC <- readRDS("data/DGE/Species/Day15_DEGs_HC.RDS")
Day30_DEGs_HC <- readRDS("data/DGE/Species/Day30_DEGs_HC.RDS")


```

```{r Volcano_Plot_Function}
generate_volcano_plot <- function(toptable, title) {
  
  # #check for entrezid 
  # if(!"Entrez_ID" %in% colnames(toptable)) stop("Entrez_ID col not present")
  # 
  #make significance labels
  
  toptable <- toptable %>% 
    mutate(Significance = case_when(
      logFC > 0 & adj.P.Val < 0.05 ~ "Upregulated",
      logFC < 0 & adj.P.Val < 0.05 ~ "Downregulated",
      TRUE  ~ "Not Significant"
    ))
  
  #factor significance
  toptable$Significance <- factor(
    toptable$Significance, 
    levels = c("Upregulated", 
               "Not Significant", 
               "Downregulated")
  )
  
  #count genes in each category
  upgenes <- sum(toptable$Significance == "Upregulated")
  nsgenes <- sum(toptable$Significance == "Not Significant")
  downgenes <- sum(toptable$Significance == "Downregulated")
  
  
  #labels for legend
  legend_lab <- c(
    paste0("Upregulated: ", upgenes),
    paste0("Not Significant: ", nsgenes),
    paste0("Downregulated: ", downgenes)
  )
  
  #colors 
  color_map <- c("Upregulated" = "blue",
                 "Not Significant" = "grey30",
                 "Downregulated" = "red")
  
  #generate volcano plots
  p <- ggplot(toptable, aes(x = logFC, 
                            y = -log10(P.Value),
                            color = Significance)) +
    geom_point_rast(alpha = 0.8, size = 3) +
    scale_color_manual(values = color_map, 
                       labels = legend_lab,
                       breaks = c("Upregulated",
                                  "Not Significant", 
                                  "Downregulated"))  +
    xlim(-20,20) +
    labs(title = title, 
         x = expression("log"[2]*"FC"),
         y = expression("-log"[10]*"p-value")) +
    # theme_custom() +
    theme(legend.position = "right")
  
  return(p)
}


```

```{r FC_Plot_Function}
plot_cluster_fc <- function(gene_vector, cluster_name, top_table) {
  
  # Filter TopTable for the genes in this cluster
  df <- top_table %>% dplyr::filter(Gene %in% gene_vector) %>%
    mutate(Comparisons = factor(Comparisons, levels = c(
      "HC_D0","HC_D2","HC_D5","HC_D15","HC_D30"
    )))
  
  # Optional: print dimensions and unique genes
  cat(cluster_name, ":", dim(df)[1], "rows,", length(unique(df$Gene)), "unique genes\n")
  
  # Create boxplot
  p <- ggplot(df, aes(x = Comparisons, y = logFC)) +
    geom_boxplot(aes(fill = Comparisons)) +
    guides(fill = guide_legend(title = "Comparisons")) +
    theme_bw() +
    xlab(" ") +
    ylab("logFC") +
    ggtitle(paste0(cluster_name, " RNA FC Comparisons")) +
    theme(
      plot.title = element_text(size = rel(1.5), hjust = 0.5),
      axis.title = element_text(size = 15, colour = "black"),
      strip.background = element_rect(fill = "#CAD899"),
      axis.text.x = element_text(size = 8, colour = "white", angle = 15),
      strip.text.x = element_text(size = 12, colour = "black", face = "bold")
    )
  
  return(p)
}
```

```{r AbsFC_Plot_Function}
plot_cluster_absfc <- function(gene_vector, cluster_name, top_table) {
  
  # Filter TopTable for the genes in this cluster
  df <- top_table %>% dplyr::filter(Gene %in% gene_vector) %>%
    mutate(Comparisons = factor(Comparisons, levels = c(
      "HC_D0","HC_D2","HC_D5","HC_D15","HC_D30"
    )))
  
  # Optional: print dimensions and unique genes
  cat(cluster_name, ":", dim(df)[1], "rows,", length(unique(df$Gene)), "unique genes\n")
  
  # Create boxplot
  p <- ggplot(df, aes(x = Comparisons, y = AbsFC)) +
    geom_boxplot(aes(fill = Comparisons)) +
    guides(fill = guide_legend(title = "Comparisons")) +
    theme_bw() +
    xlab(" ") +
    ylab("AbsFC") +
    ggtitle(paste0(cluster_name, " RNA AbsFC Comparisons")) +
    theme(
      plot.title = element_text(size = rel(1.5), hjust = 0.5),
      axis.title = element_text(size = 15, colour = "black"),
      strip.background = element_rect(fill = "#CAD899"),
      axis.text.x = element_text(size = 8, colour = "white", angle = 15),
      strip.text.x = element_text(size = 12, colour = "black", face = "bold")
    )
  
  return(p)
}
```


```{r RNASeq_DGE_Species_Data}
# Filt_RMG0_RNA_fc_NoD4_NoRep_Symbol <- Filt_RMG0_RNA_fc_NoD4_NoRep_EntrezID_Symbol %>% 
#   dplyr::select(-Entrez_ID) %>% 
#   column_to_rownames("SYMBOL")

Filt_RMG0_RNA_fc_NoD4_NoRep <- Filt_RMG0_RNA_fc_NoD4 %>% 
  dplyr::select(-(contains("R")))

RNA_Metadata_NoD4_NoRep <- RNA_Metadata %>% 
  dplyr::filter(Timepoint != "Day4") %>% 
  dplyr::slice(-43:-46)
rownames(RNA_Metadata_NoD4_NoRep) <- colnames(Filt_RMG0_RNA_fc_NoD4_NoRep)
# saveRDS(RNA_Metadata_NoD4_NoRep,"data/DGE/Species/RNA_Metadata_NoD4_NoRep.RDS")

RNA_Metadata_NoD4_NoRep$dgelist <- c(rep(c("Human_Day0","Human_Day2","Human_Day5","Human_Day15","Human_Day30"),7),
                                     rep(c("Chimp_Day0","Chimp_Day2","Chimp_Day5","Chimp_Day15","Chimp_Day30"),7))
#create DGEList object
dge <- DGEList(counts = Filt_RMG0_RNA_fc_NoD4_NoRep)
dge$samples$group <- factor(RNA_Metadata_NoD4_NoRep$dgelist)
dge <- calcNormFactors(dge, method = "TMM")
dge$samples

#dim(dge)
# saveRDS(dge, "data/DGE/Species/RNA_dge_matrix.RDS")
#dge$samples


```


```{r RNASeq_DGE_Species_Data_Model}
# design1 <- model.matrix(~ 0 + RNA_Metadata_NoD4_NoRep$dgelist)
# colnames(design1) <- gsub("RNA_Metadata_NoD4_NoRep\\$dgelist", "", colnames(design1))
# View(design1)
# 
# corfit <- duplicateCorrelation(object = dge$counts, design = design1, block = RNA_Metadata_NoD4_NoRep$Individual)
# v <- voom(dge, design1, block = RNA_Metadata_NoD4_NoRep$Individual, correlation = corfit$consensus.correlation, plot = TRUE)
# fit <- lmFit(v, design1, block = RNA_Metadata_NoD4_NoRep$Individual, correlation = corfit$consensus.correlation)
# 
# contrast_matrix <- makeContrasts(
#   HC_D0 = Chimp_Day0 - Human_Day0,
#   HC_D2 = Chimp_Day2 - Human_Day2,
#   HC_D5 = Chimp_Day5 - Human_Day5,
#   HC_D15 = Chimp_Day15 - Human_Day15,
#   HC_D30 = Chimp_Day30 - Human_Day30,
#   levels = design1)
# 
# fit2 <- contrasts.fit(fit,contrast_matrix)
# fit2 <- eBayes(fit2)
# 
# plotSA(fit2, main = "RNA Model")
# 
# results_summary <- decideTests(fit2,
#                                adjust.method = "BH",
#                                p.value = 0.05)
# summary(results_summary)
# saveRDS(fit2,"data/DGE/Species/fit2.RDS")
```

```{r RNASeq_DGE_Species_TopTable}
fit2 <- readRDS("data/DGE/Species/fit2.RDS")

#Create Human TopTable. using listapply, then you can pull specific comp using the $
TopTables_RNA_names <- colnames(fit2$coefficients) 

colnames(fit2$coefficients)

TopTable_RNA_All <- do.call(
  rbind,
  lapply(TopTables_RNA_names,function(ct) {
    
    tt <- topTable(
      fit2,
      coef = ct,
      number = Inf,
      sort.by = "p"
    )
    
    #add identifiers
    tt$Gene <- rownames(tt)
    tt$Comparisons <- ct
    
    tt
  })
)

TopTable_RNA_All$Comparisons
# saveRDS(TopTable_RNA_All,"data/TopTable_RNA_all.RDS")
head(TopTable_RNA_All)
```



```{r RNASeq_DGE_Species_TopTable_VolcancoPlots}
TopTable_RNA_All <- readRDS("data/TopTable_RNA_all.RDS")
Comparisons_names <- unique(TopTable_RNA_All$Comparisons)
# saveRDS(Comparisons_names,"data/DGE/Comparisons_names_Trajectory.RDS")
plot <- list()
for (n in Comparisons_names) {

plot[[n]] <- TopTable_RNA_All %>% 
  dplyr::filter(Comparisons == paste0(n)) %>% 
  generate_volcano_plot(.,n)
}

for (n in Comparisons_names) {
  print(plot[[n]])
        }
```

```{r RNASeq_DGE_Species_TopTable_Subsetting}
TopTable_RNA_All <- readRDS("data/TopTable_RNA_all.RDS")

Day0_DEGs_HC <- TopTable_RNA_All %>% 
  dplyr::filter(Comparisons == "HC_D0",
                adj.P.Val < 0.05)
print("Day0_DEGs_HC")
length(Day0_DEGs_HC$Gene)

Day2_DEGs_HC <- TopTable_RNA_All %>% 
  dplyr::filter(Comparisons == "HC_D2",
                adj.P.Val < 0.05)
print("Day2_DEGs_HC")
length(Day2_DEGs_HC$Gene)

Day5_DEGs_HC <- TopTable_RNA_All %>% 
  dplyr::filter(Comparisons == "HC_D5",
                adj.P.Val < 0.05)
print("Day5_DEGs_HC")
length(Day5_DEGs_HC$Gene)

Day15_DEGs_HC <- TopTable_RNA_All %>% 
  dplyr::filter(Comparisons == "HC_D15",
                adj.P.Val < 0.05)
print("Day15_DEGs_HC")
length(Day15_DEGs_HC$Gene)

Day30_DEGs_HC <- TopTable_RNA_All %>% 
  dplyr::filter(Comparisons == "HC_D30",
                adj.P.Val < 0.05)
print("Day30_DEGs_HC")
length(Day30_DEGs_HC$Gene)

all_genes <- unique(TopTable_RNA_All$Gene)
print("All Expressed Genes")
length(all_genes)

deg_genes <- TopTable_RNA_All %>%
  dplyr::filter(adj.P.Val < 0.05) %>%
  dplyr::pull(Gene) %>%
  unique()
print("DEG in at least one time point")
length(deg_genes)

# saveRDS(Day0_DEGs_HC,"data/DGE/Species/Day0_DEGs_HC.RDS")
# saveRDS(Day2_DEGs_HC,"data/DGE/Species/Day2_DEGs_HC.RDS")
# saveRDS(Day5_DEGs_HC,"data/DGE/Species/Day5_DEGs_HC.RDS")
# saveRDS(Day15_DEGs_HC,"data/DGE/Species/Day15_DEGs_HC.RDS")
# saveRDS(Day30_DEGs_HC,"data/DGE/Species/Day30_DEGs_HC.RDS")
# saveRDS(all_genes,"data/DGE/Species/ExpressedGenes.RDS")
# saveRDS(deg_genes,"data/DGE/Species/DEG_AtLeastOne.RDS")

DEG_Lists <- list(
  all_deg_genes = deg_genes,             # can be a vector
  Day0_DEGs_HC = Day0_DEGs_HC$Gene,       # TopTable data.frame
  Day2_DEGs_HC = Day2_DEGs_HC$Gene,
  Day5_DEGs_HC = Day5_DEGs_HC$Gene,
  Day15_DEGs_HC = Day15_DEGs_HC$Gene,
  Day30_DEGs_HC = Day30_DEGs_HC$Gene
)

fit_list <- list()

for (name in names(DEG_Lists)) {
  
  deg_vector <- DEG_Lists[[name]]   # extract the gene vector
  
  # Create Euler object
  fit_list[[name]] <- euler(list(
    NonDEGs = all_genes,
    DEGs = deg_vector
  ))
  
  # Print plot in RMarkdown
  print(plot(
    fit_list[[name]],
    fills = list(
      fill = c("grey80", "firebrick"),
      alpha = 0.6
    ),
    labels = TRUE,
    quantities = TRUE,
    main = name   # title
  ))
}

```

```{r RNASeq_DGE_Species_TopTable_Subsetting_barplot}
####proportion bar plots####
#first factor the timepoints so that they are in the right order
df <- data.frame(
  Day = c("Day0", "Day2", "Day5", "Day15", "Day30"),
  DEGs = c(6569, 4094, 4145, 5070, 5990),
  Non_DEGs = c(8269, 10744, 10684, 9768, 8848)
)

# Convert to long format for ggplot
df_long <- df %>%
  pivot_longer(cols = c(DEGs, Non_DEGs),
               names_to = "Type",
               values_to = "Count") %>%
  group_by(Day) %>%
  mutate(Proportion = Count / sum(Count))  # calculate proportions

df_long$Day <- factor(df_long$Day,levels = c("Day0", "Day2", "Day5", "Day15", "Day30"),ordered = TRUE)

df_long

ggplot(df_long, aes(x = Day, y = Proportion, fill = Type)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = scales::percent_format()) +  # show % on y-axis
  scale_fill_manual(values = c("DEGs" = "#E41A1C", "Non_DEGs" = "#377EB8")) + # custom colors
  labs(y = "Proportion", x = "Day", fill = "") +
  theme_minimal(base_size = 14)

```

```{r RNASeq_DGE_Species_TopTable_Venn_Eulers}
# # Your DEGs per day
# Day0 <- unique(Day0_DEGs_HC$Gene)
# Day2 <- unique(Day2_DEGs_HC$Gene)
# Day5 <- unique(Day5_DEGs_HC$Gene)
# Day15 <- unique(Day15_DEGs_HC$Gene)
# Day30 <- unique(Day30_DEGs_HC$Gene)
# 
# sets <- list(Day0 = Day0, Day2 = Day2, Day5 = Day5, Day15 = Day15, Day30 = Day30)
# 
# 
# fit5 <- euler(sets)
# 
# # Extract counts for all intersections
# counts <- as.data.frame(fit5$original.values)
# counts$Intersection <- rownames(counts)
# 
# # Rearrange columns for clarity
# counts <- counts[, c("Intersection", "fit5$original.values")]
# colnames(counts) <- c("Days", "GeneCount")
# 
# counts
# 
# # saveRDS(fit5,"data/DGE/Species/Venn_Day_Overlaps.RDS")
# 
# plot(
#   fit5,
#   fills = list(
#     alpha = 0.6
#   ),
#   quantities = TRUE,
#   main = "5-way DEGs"
# )
```

```{r RNASeq_DGE_Species_TopTable_Venn_ggplot}
library(ggVennDiagram)
library(ggplot2)

# Your DEGs per day (already defined)
sets <- list(
  Day0 = Day0,
  Day2 = Day2,
  Day5 = Day5,
  Day15 = Day15,
  Day30 = Day30
)
```


```{r RNASeq_DGE_Species_TopTable_Venn_ggplot_plot,fig. width=4 height=4}
# Create a 5-way Venn diagram
p <- ggVennDiagram(sets,
                   label_alpha = 0,       # makes background of labels transparent
                   label = "count") +     # show counts in intersections
  scale_fill_gradient(low = "skyblue", high = "navy") + # optional color gradient
  theme(legend.position = "none") +                     # hide legend
  ggtitle("5-way DEGs")

# Plot
print(p)

```

```{r RNASeq_DGE_Species_TopTable_Venn_Intersections}

# Your sets
sets <- list(
  Day0 = Day0,
  Day2 = Day2,
  Day5 = Day5,
  Day15 = Day15,
  Day30 = Day30
)

# Helper function to get intersections
get_intersections <- function(sets_list) {
  set_names <- names(sets_list)
  n <- length(sets_list)
  result <- list()
  
  # Loop over all combination lengths (1 to n)
  for (k in 1:n) {
    combos <- combn(set_names, k, simplify = FALSE)
    for (combo in combos) {
      # Start with first set in combo
      genes <- sets_list[[combo[1]]]
      # Intersect with the rest
      if (length(combo) > 1) {
        for (s in combo[-1]) {
          genes <- intersect(genes, sets_list[[s]])
        }
      }
      # Remove genes that appear in other sets outside the combo (exclusive)
      other_sets <- setdiff(set_names, combo)
      if (length(other_sets) > 0) {
        for (s in other_sets) {
          genes <- setdiff(genes, sets_list[[s]])
        }
      }
      # Save if any genes remain
      if (length(genes) > 0) {
        result[[paste(combo, collapse = "&")]] <- genes
      }
    }
  }
  return(result)
}

# Compute all intersections
all_intersections <- get_intersections(sets)
saveRDS(all_intersections,"data/DGE/Species/all_intersections.RDS")

# # Example: genes only in Day0
# all_intersections$Day0

# # Example: genes only in Day0 & Day2
# all_intersections$`Day0&Day2`


```


```{r RNASeq_DGE_FC_CormotifClusters}
TopTable_RNA_All <- readRDS("data/TopTable_RNA_all.RDS")
clust1_RNA <- readRDS("data/Cormotif/Species/clust1_RNA_Species.RDS")
clust2_RNA <- readRDS("data/Cormotif/Species/clust2_RNA_Species.RDS")
clust3_RNA <- readRDS("data/Cormotif/Species/clust3_RNA_Species.RDS")
clust4_RNA <- readRDS("data/Cormotif/Species/clust4_RNA_Species.RDS")


TopTable_RNA_All$AbsFC <- abs(TopTable_RNA_All$logFC)
cluster_names <- c("clust1_RNA","clust2_RNA","clust3_RNA","clust4_RNA")


```

```{r RNASeq_DGE_Clusters_FC}
cluster_lists <- list(
  clust1_RNA  = clust1_RNA,
  clust2_RNA  = clust2_RNA,
  clust3_RNA  = clust3_RNA,
  clust4_RNA  = clust4_RNA
)

cluster_plots <- lapply(names(cluster_lists), function(clust_name) {
  plot_cluster_fc(cluster_lists[[clust_name]], clust_name, TopTable_RNA_All)
})
names(cluster_plots) <- names(cluster_lists)

for (p in cluster_plots) print(p)


```

```{r RNASeq_DGE_Clusters_AbsFC}
cluster_lists <- list(
  clust1_RNA  = clust1_RNA,
  clust2_RNA  = clust2_RNA,
  clust3_RNA  = clust3_RNA,
  clust4_RNA  = clust4_RNA
)

cluster_plots <- lapply(names(cluster_lists), function(clust_name) {
  plot_cluster_absfc(cluster_lists[[clust_name]], clust_name, TopTable_RNA_All)
})
names(cluster_plots) <- names(cluster_lists)

for (p in cluster_plots) print(p)


```

```{r Updating Website, eval = FALSE}

# git -> commit all changes
# git -> push
# wflow_publish("analysis/DGE/RNA_DGE_Comp_Species_Ensemble.Rmd")

```
